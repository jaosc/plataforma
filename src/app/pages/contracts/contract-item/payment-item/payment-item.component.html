<form (ngSubmit)="registerPayment()" #form="ngForm" aria-labelledby="title">
  <div class="row">
    <div class="col-sm-4">
      <div class="form-control-group">
        <label class="label" for="input-value">Valor:</label>
        <input
          nbInput
          [(ngModel)]="payment.value"
          #value="ngModel"
          id="input-value"
          name="value"
          placeholder="Valor empenhado"
          fullWidth
          fieldSize="large"
          [brmasker]="{
            money: true,
            thousand: '.',
            decimalCaracter: ',',
            decimal: '2'
          }"
          [required]="validation.value.required"
          [status]="
            value.dirty ? (value.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="value.invalid && value.touched ? true : null"
          [readonly]="false"
          (ngModelChange)="toLiquid(payment.value)"
        />
        <ng-container *ngIf="value.invalid && value.touched">
          <p class="caption status-danger" *ngIf="value.errors?.required">
            O valor do empenho é obrigatório!
          </p>
          <p
            class="caption status-danger"
            *ngIf="value.errors?.minlength || value.errors?.maxlength"
          >
            O valor do empenho deve conter entre
            {{ validation.value.minLength }} a
            {{ validation.value.maxLength }}
            numeros
          </p>
        </ng-container>
      </div>
    </div>
    <div class="col-sm-2">
      <div class="form-control-group">
        <label class="label" for="input-nf">NF(%):</label>
        <input
          nbInput
          [(ngModel)]="payment.notaFiscal"
          #nf="ngModel"
          id="input-nf"
          name="nf"
          placeholder="Revisão"
          fullWidth
          fieldSize="large"
          [required]="validation.nf.required"
          [status]="nf.dirty ? (nf.invalid ? 'danger' : 'success') : 'basic'"
          [attr.aria-invalid]="nf.invalid && nf.touched ? true : null"
          [readonly]="true"
        />
      </div>
    </div>
    <div class="col-sm-2">
      <div class="form-control-group">
        <label class="label" for="input-nortan">Nortan(%):</label>
        <input
          nbInput
          [(ngModel)]="payment.nortanPercentage"
          #nortan="ngModel"
          id="input-nortan"
          name="nortan"
          placeholder="Revisão"
          fullWidth
          fieldSize="large"
          [required]="validation.nortan.required"
          [status]="
            nortan.dirty ? (nortan.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="nortan.invalid && nortan.touched ? true : null"
          [readonly]="true"
        />
      </div>
    </div>
    <div class="col-sm-4">
      <div class="form-control-group">
        <label class="label" for="input-liquid">Valor liquído:</label>
        <input
          nbInput
          [(ngModel)]="options.liquid"
          #liquid="ngModel"
          id="input-liquid"
          name="liquid"
          placeholder="Valor liquido"
          fullWidth
          fieldSize="large"
          [brmasker]="{
            money: true,
            thousand: '.',
            decimalCaracter: ',',
            decimal: '2'
          }"
          [required]="validation.liquid.required"
          [status]="
            liquid.dirty ? (liquid.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="liquid.invalid && liquid.touched ? true : null"
          [readonly]="true"
        />
      </div>
    </div>
  </div>
  <div class="form-control-group">
    <label class="label" for="input-service">Serviço:</label>
    <textarea
      nbInput
      [(ngModel)]="payment.service"
      #service="ngModel"
      id="input-service"
      name="service"
      placeholder="Descreva o serviço efetuado nessa ordem de empenho"
      fullWidth
      fieldSize="large"
      [required]="validation.service.required"
      [minlength]="validation.service.minLength"
      [maxlength]="validation.service.maxLength"
      [status]="
        service.dirty ? (service.invalid ? 'danger' : 'success') : 'basic'
      "
      [attr.aria-invalid]="service.invalid && service.touched ? true : null"
    ></textarea>
    <ng-container *ngIf="service.invalid && service.touched">
      <p class="caption status-danger" *ngIf="service.errors?.required">
        O campo de serviço é obrigatório!
      </p>
      <p
        class="caption status-danger"
        *ngIf="service.errors?.minlength || service.errors?.maxlength"
      >
        O campo de serviço deve conter entre
        {{ validation.service.minLength }} a
        {{ validation.service.maxLength }}
        caracteres
      </p>
    </ng-container>
  </div>
  <hr />
  <div class="row" *ngIf="paymentIndex === undefined">
    <div class="col-sm-4">
      <div class="form-control-group">
        <label class="label" for="input-user">Colaborador:</label>
        <nb-select
          [(ngModel)]="userPayment.user"
          #userList="ngModel"
          id="input-user"
          name="userList"
          placeholder="Nome do colaborador"
          fullWidth
          size="large"
          [required]="validation.user.required"
          [status]="userList.value ? 'success' : 'basic'"
          [attr.aria-invalid]="
            userList.invalid && userList.touched ? true : null
          "
        >
          <nb-option *ngFor="let user of USERS" [value]="user._id">
            {{ user.fullName }}
          </nb-option>
        </nb-select>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="form-control-group">
        <label class="label" for="input-coordination">Coordenação:</label>
        <nb-select
          [(ngModel)]="userPayment.coordination"
          #coordination="ngModel"
          id="input-coordination"
          name="coordination"
          placeholder="Coordenação"
          fullWidth
          size="large"
          [required]="validation.coordination.required"
          [status]="coordination.value ? 'success' : 'basic'"
          [attr.aria-invalid]="
            coordination.invalid && coordination.touched ? true : null
          "
        >
          <nb-option
            *ngFor="let coordination of COORDINATIONS"
            [value]="coordination"
          >
            {{ coordination }}
          </nb-option>
        </nb-select>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="form-control-group">
        <label
          class="label"
          for="input-paid"
          style="display: flex; margin-top: 4px;"
        >
          <span style="margin-right: 10px;">Valor:</span>
          <nb-radio-group
            [(ngModel)]="options.valueType"
            #valueType="ngModel"
            id="input-value-type"
            name="valueType"
            style="height: 16px;"
          >
            <nb-radio value="$" style="height: 16px;">R$</nb-radio>
            <nb-radio value="%" style="height: 16px;">%</nb-radio>
          </nb-radio-group>
        </label>
        <input
          nbInput
          [(ngModel)]="userPayment.value"
          #paid="ngModel"
          id="input-paid"
          name="paid"
          placeholder="Valor"
          fullWidth
          fieldSize="large"
          [brmasker]="
            options.valueType !== '%'
              ? {
                  money: true,
                  thousand: '.',
                  decimalCaracter: ',',
                  decimal: '2'
                }
              : { percent: true }
          "
          [required]="validation.paid.required"
          [status]="paid.value ? 'success' : 'basic'"
          [attr.aria-invalid]="paid.invalid && paid.touched ? true : null"
          [readonly]="false"
        />
      </div>
    </div>
    <div class="col-sm-1">
      <button
        nbButton
        type="button"
        fullWidth
        status="primary"
        size="large"
        style="margin-top: 28px;"
        [disabled]="!paid.value || !coordination.value || !userList.value"
        (click)="addColaborator()"
      >
        +
      </button>
    </div>
  </div>
  <nb-list style="width: 100%; padding: 10px 0;">
    <nb-list-item *ngFor="let userPayment of payment.team; let i = index">
      <div class="row paymentRow">
        <div class="col-sm-4">
          {{
            userPayment.user.fullName
              ? userPayment.user.fullName
              : idToName(userPayment.user)
          }}
        </div>
        <div class="col-sm-4">
          {{ userPayment.coordination }}
        </div>
        <div class="col-sm-2">
          {{ userPayment.value }}
        </div>
        <div class="col-sm-1">
          {{ toPercentage(userPayment.value) }}
        </div>
        <div class="col-sm-1">
          <nb-icon
            *ngIf="this.paymentIndex === undefined"
            class="xIcon"
            status="basic"
            icon="close-outline"
            pack="nebular-essentials"
            (click)="payment.team.splice(i, 1); updateTotal()"
          ></nb-icon>
        </div>
      </div>
    </nb-list-item>
    <nb-list-item>
      <div class="row paymentRow">
        <div class="col-sm-8" style="text-align: right;">
          Total:
        </div>
        <div
          class="col-sm-2"
          [ngClass]="{
            danger: total !== options.liquid && total !== '0',
            success: total === options.liquid && total !== '0'
          }"
        >
          {{ total }}
        </div>
        <div
          class="col-sm-1"
          [ngClass]="{
            danger: total !== options.liquid && total !== '0',
            success: total === options.liquid && total !== '0'
          }"
        >
          {{ toPercentage(total) }}
        </div>
        <div class="col-sm-1"></div>
      </div>
    </nb-list-item>
  </nb-list>
  <button
    nbButton
    fullWidth
    status="primary"
    size="large"
    [disabled]="
      submitted || !form.valid || isTeamEmpty() || total !== options.liquid
    "
    [class.btn-pulse]="submitted"
  >
    {{ paymentIndex !== undefined ? 'Atualizar' : 'Adicionar' }}
  </button>
</form>
