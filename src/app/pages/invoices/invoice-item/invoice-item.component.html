<form (ngSubmit)="registerInvoice()" #form="ngForm" aria-labelledby="title">
  <nb-tabset fullWidth>
    <nb-tab tabTitle="Principal">
      <div class="row">
        <div class="col-sm-6">
          <div class="form-control-group">
            <label class="label" for="input-department">Diretoria:</label>
            <nb-select
              [(ngModel)]="invoice.department"
              #department="ngModel"
              id="input-department"
              name="department"
              placeholder="Selecione a diretoria"
              fullWidth
              size="large"
              [required]="validation.department.required"
              [status]="
                department.dirty
                  ? department.invalid
                    ? 'danger'
                    : 'success'
                  : 'basic'
              "
              [attr.aria-invalid]="
                department.invalid && department.touched ? true : null
              "
              [disabled]="editing"
              (selectedChange)="onDepartmentChange()"
            >
              <nb-option
                *ngFor="let department of DEPARTMENTS"
                [value]="department"
              >
                {{ department }}
              </nb-option>
            </nb-select>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="form-control-group">
            <label class="label" for="input-coordination">Coordenação:</label>
            <nb-select
              [(ngModel)]="invoice.coordination"
              #coordination="ngModel"
              id="input-coordination"
              name="coordination"
              placeholder="Selecione a coordenação"
              fullWidth
              size="large"
              [required]="validation.coordination.required"
              [status]="
                coordination.dirty
                  ? coordination.invalid
                    ? 'danger'
                    : 'success'
                  : 'basic'
              "
              [attr.aria-invalid]="
                coordination.invalid && coordination.touched ? true : null
              "
              [disabled]="false"
            >
              <nb-option
                *ngFor="let coordination of COORDINATIONS"
                [value]="coordination"
              >
                {{ coordination }}
              </nb-option>
            </nb-select>
          </div>
        </div>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-code">Código do orçamento:</label>
        <input
          nbInput
          [(ngModel)]="invoice.code"
          #code="ngModel"
          id="input-code"
          name="code"
          placeholder="Código do Orçamento"
          fullWidth
          fieldSize="large"
          [required]="validation.code.required"
          [minlength]="validation.code.minLength"
          [maxlength]="validation.code.maxLength"
          [status]="
            code.dirty ? (code.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="code.invalid && code.touched ? true : null"
          [disabled]="true"
        />
      </div>

      <div class="form-control-group">
        <label class="label" for="input-type"
          >Tipologia do empreendimento:</label
        >
        <input
          nbInput
          [(ngModel)]="invoice.type"
          #type="ngModel"
          id="input-type"
          name="type"
          placeholder="Tipologia do contrato"
          fullWidth
          autofocus
          fieldSize="large"
          [required]="validation.type.required"
          [minlength]="validation.type.minLength"
          [maxlength]="validation.type.maxLength"
          [status]="
            type.dirty ? (type.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="type.invalid && type.touched ? true : null"
          [disabled]="false"
        />
        <ng-container *ngIf="type.invalid && type.touched">
          <p class="caption status-danger" *ngIf="type.errors?.required">
            A tipologia do empreendimento é obrigatória!
          </p>
          <p
            class="caption status-danger"
            *ngIf="type.errors?.minlength || type.errors?.maxlength"
          >
            A tipologia do empreendimento deve conter entre
            {{ validation.type.minLength }} a
            {{ validation.type.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>

      <div class="form-control-group">
        <label class="label" for="input-service">Serviço:</label>
        <textarea
          nbInput
          [(ngModel)]="invoice.service"
          #service="ngModel"
          id="input-service"
          name="service"
          placeholder="Descreva o serviço a ser realizado"
          fullWidth
          fieldSize="large"
          [required]="validation.service.required"
          [minlength]="validation.service.minLength"
          [maxlength]="validation.service.maxLength"
          [status]="
            service.dirty ? (service.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="service.invalid && service.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="service.invalid && service.touched">
          <p class="caption status-danger" *ngIf="service.errors?.required">
            A descrição do serviço é obrigatória!
          </p>
          <p
            class="caption status-danger"
            *ngIf="service.errors?.minlength || service.errors?.maxlength"
          >
            A descrição do serviço deve conter entre
            {{ validation.service.minLength }} a
            {{ validation.service.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>

      <div class="row">
        <div class="col-9 col-md-11">
          <div class="form-control-group">
            <label class="label" for="input-contractor">Cliente:</label>
            <nb-select
              [(ngModel)]="invoice.contractor"
              #contractor="ngModel"
              id="input-contractor"
              name="contractor"
              placeholder="Selecione o cliente do orçamento"
              fullWidth
              size="large"
              [nbTooltip]="tooltipText(invoice.contractor)"
              [nbTooltipTrigger]="
                isPhone() || invoice.contractor === undefined ? 'noop' : 'hint'
              "
              nbTooltipPlacement="top"
              nbTooltipStatus="primary"
              (selectedChange)="
                invoice.contractorFullName = contractorService.idToName(
                  invoice.contractor
                )
              "
              [required]="validation.contractor.required"
              [status]="
                contractor.dirty
                  ? contractor.invalid
                    ? 'danger'
                    : 'success'
                  : 'basic'
              "
              [attr.aria-invalid]="
                contractor.invalid && contractor.touched ? true : null
              "
            >
              <nb-option
                *ngFor="let contractorItem of CONTRACTORS"
                [value]="contractorItem._id"
                [nbTooltip]="tooltipText(contractorItem)"
                [nbTooltipTrigger]="isPhone() ? 'noop' : 'hint'"
                nbTooltipPlacement="top"
                nbTooltipStatus="primary"
                nbTooltipAdjustment="noop"
              >
                {{ contractorItem.fullName }}
              </nb-option>
            </nb-select>
          </div>
        </div>
        <div class="col-3 col-md-1">
          <div class="form-control-group">
            <button
              nbButton
              type="button"
              fullWidth
              status="primary"
              size="large"
              style="margin-top: 28px"
              nbTooltip="Adicionar cliente"
              [nbTooltipTrigger]="isPhone() ? 'noop' : 'hint'"
              nbTooltipPlacement="top"
              nbTooltipStatus="info"
              (click)="addContractor()"
            >
              <nb-icon icon="person-add-outline"></nb-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="form-control-group">
        <label class="label" for="input-name">Empreendimento:</label>
        <input
          nbInput
          [(ngModel)]="invoice.name"
          #name="ngModel"
          id="input-name"
          name="name"
          placeholder="Nome do empreendimento"
          fullWidth
          fieldSize="large"
          [required]="validation.name.required"
          [minlength]="validation.name.minLength"
          [maxlength]="validation.name.maxLength"
          [status]="
            name.dirty ? (name.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="name.invalid && name.touched ? true : null"
          [disabled]="false"
        />
        <ng-container *ngIf="name.invalid && name.touched">
          <p class="caption status-danger" *ngIf="name.errors?.required">
            O nome do empreendimento é obrigatório!
          </p>
          <p
            class="caption status-danger"
            *ngIf="name.errors?.minlength || name.errors?.maxlength"
          >
            O nome do empreendimento deve conter entre
            {{ validation.name.minLength }} a
            {{ validation.name.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>

      <div class="form-control-group">
        <label class="label" for="input-value">Valor do contrato:</label>
        <input
          nbInput
          [(ngModel)]="invoice.value"
          #value="ngModel"
          id="input-value"
          name="value"
          placeholder="Valor do contrato"
          fullWidth
          fieldSize="large"
          [brmasker]="{
            money: true,
            thousand: '.',
            decimalCaracter: ',',
            decimal: '2'
          }"
          [required]="validation.value.required"
          [minlength]="validation.value.minLength"
          [maxlength]="validation.value.maxLength"
          [status]="
            value.dirty ? (value.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="value.invalid && value.touched ? true : null"
          [disabled]="false"
        />
        <ng-container *ngIf="value.invalid && value.touched">
          <p class="caption status-danger" *ngIf="value.errors?.required">
            O valor do contrato é obrigatório!
          </p>
          <p
            class="caption status-danger"
            *ngIf="value.errors?.minlength || value.errors?.maxlength"
          >
            O valor do contrato deve conter entre
            {{ validation.value.minLength }} a
            {{ validation.value.maxLength }}
            numeros
          </p>
        </ng-container>
      </div>

      <div class="row">
        <div class="col-sm-6">
          <div class="form-control-group">
            <label class="label" for="input-status">Status:</label>
            <nb-select
              [(ngModel)]="invoice.status"
              #status="ngModel"
              id="input-status"
              name="status"
              placeholder="Selecione o status do orçamento"
              fullWidth
              size="large"
              [required]="validation.status.required"
              [status]="
                status.dirty ? (status.invalid ? 'danger' : 'success') : 'basic'
              "
              [attr.aria-invalid]="
                status.invalid && status.touched ? true : null
              "
              [disabled]="oldStatus == 'Fechado'"
            >
              <nb-option *ngFor="let status of STATOOS" [value]="status">
                {{ status }}
              </nb-option>
            </nb-select>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="form-control-group">
            <label class="label">
              <!-- TODO: Remover depois de adicionar data de criação para todos os orçamentos -->
              <!-- >{{ editing ? 'Última atualização' : 'Data de criação' }}:</label -->
              {{ 'Data de criação' }}:</label
            >
            <!-- TODO: Alterar ngIf para editing depois de adicionar data de criação dos orçamentos -->
            <input
              *ngIf="false; else datePicker"
              nbInput
              [(ngModel)]="invoice.lastUpdate"
              #date="ngModel"
              id="input-date"
              name="date"
              placeholder="Escolha uma data"
              fullWidth
              fieldSize="large"
              [required]="validation.date.required"
              [status]="
                date.dirty ? (date.invalid ? 'danger' : 'success') : 'basic'
              "
              [attr.aria-invalid]="date.invalid && date.touched ? true : null"
              [readonly]="true"
            />
            <ng-template #datePicker>
              <input
                nbInput
                [(ngModel)]="invoice.created"
                #date="ngModel"
                id="input-date"
                name="date"
                placeholder="Escolha uma data"
                fullWidth
                fieldSize="large"
                (ngModelChange)="fixHours()"
                [nbDatepicker]="datepicker"
                [required]="validation.date.required"
                [status]="
                  date.dirty ? (date.invalid ? 'danger' : 'success') : 'basic'
                "
                [attr.aria-invalid]="date.invalid && date.touched ? true : null"
                [readonly]="true"
              />
              <nb-datepicker #datepicker [max]="today"></nb-datepicker>
            </ng-template>
          </div>
        </div>
      </div>
    </nb-tab>
    <nb-tab tabTitle="Complementar">
      <div class="row">
        <div class="col-auto">
          <label class="label-divider">Cabeçalho</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-subtitle1">Subtítulo linha 1:</label>
        <input
          nbInput
          [(ngModel)]="invoice.subtitle1"
          #subtitle1="ngModel"
          id="input-subtitle1"
          name="subtitle1"
          placeholder="Digite os produtos do orçamento. ex: interiores + complementares"
          fullWidth
          fieldSize="large"
          [minlength]="validation.subtitle1.minLength"
          [maxlength]="validation.subtitle1.maxLength"
          [status]="
            subtitle1.dirty
              ? subtitle1.invalid
                ? 'danger'
                : 'success'
              : 'basic'
          "
          [attr.aria-invalid]="
            subtitle1.invalid && subtitle1.touched ? true : null
          "
          [disabled]="false"
        />
        <ng-container *ngIf="subtitle1.invalid && subtitle1.touched">
          <p
            class="caption status-danger"
            *ngIf="subtitle1.errors?.minlength || subtitle1.errors?.maxlength"
          >
            O subtítulo 1 deve conter entre
            {{ validation.subtitle1.minLength }} a
            {{ validation.subtitle1.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-subtitle2">Subtítulo linha 2:</label>
        <input
          nbInput
          [(ngModel)]="invoice.subtitle2"
          #subtitle2="ngModel"
          id="input-subtitle2"
          name="subtitle2"
          placeholder="Continuação dos produtos (opcional)"
          fullWidth
          fieldSize="large"
          [minlength]="validation.subtitle2.minLength"
          [maxlength]="validation.subtitle2.maxLength"
          [status]="
            subtitle2.dirty
              ? subtitle2.invalid
                ? 'danger'
                : 'success'
              : 'basic'
          "
          [attr.aria-invalid]="
            subtitle2.invalid && subtitle2.touched ? true : null
          "
          [disabled]="false"
        />
        <ng-container *ngIf="subtitle2.invalid && subtitle2.touched">
          <p
            class="caption status-danger"
            *ngIf="subtitle2.errors?.minlength || subtitle2.errors?.maxlength"
          >
            O subtítulo 2 deve conter entre
            {{ validation.subtitle2.minLength }} a
            {{ validation.subtitle2.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="col-auto">
          <label class="label-divider">Apresentação</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-contactName"
          >Primeiro nome do contato:</label
        >
        <input
          nbInput
          [(ngModel)]="invoice.contactName"
          #contactName="ngModel"
          id="input-contactName"
          name="contactName"
          placeholder="Primeiro nome do contato na empresa"
          fullWidth
          fieldSize="large"
          [minlength]="validation.contactName.minLength"
          [maxlength]="validation.contactName.maxLength"
          [status]="
            contactName.dirty
              ? contactName.invalid
                ? 'danger'
                : 'success'
              : 'basic'
          "
          [attr.aria-invalid]="
            contactName.invalid && contactName.touched ? true : null
          "
          [disabled]="false"
        />
        <ng-container *ngIf="contactName.invalid && contactName.touched">
          <p
            class="caption status-danger"
            *ngIf="
              contactName.errors?.minlength || contactName.errors?.maxlength
            "
          >
            O nome do contato deve conter entre
            {{ validation.contactName.minLength }} a
            {{ validation.contactName.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-contractorName">Contratante:</label>
        <input
          nbInput
          [(ngModel)]="invoice.contractorFullName"
          #contractorName="ngModel"
          id="input-contractorName"
          name="contractorName"
          placeholder="Primeiro nome do contato na empresa"
          fullWidth
          fieldSize="large"
          [minlength]="validation.contractorName.minLength"
          [maxlength]="validation.contractorName.maxLength"
          [status]="
            contractorName.dirty
              ? contractorName.invalid
                ? 'danger'
                : 'success'
              : 'basic'
          "
          [attr.aria-invalid]="
            contractorName.invalid && contractorName.touched ? true : null
          "
          [disabled]="false"
        />
        <ng-container *ngIf="contractorName.invalid && contractorName.touched">
          <p
            class="caption status-danger"
            *ngIf="
              contractorName.errors?.minlength ||
              contractorName.errors?.maxlength
            "
          >
            O nome do contratante deve conter entre
            {{ validation.contractorName.minLength }} a
            {{ validation.contractorName.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="form-control-group">
            <label class="label" for="input-user">Colaborador:</label>
            <nb-select
              [(ngModel)]="teamMember.user"
              #userList="ngModel"
              id="input-user"
              name="userList"
              placeholder="Nome do colaborador"
              fullWidth
              size="large"
              [status]="userList.value ? 'success' : 'basic'"
              [attr.aria-invalid]="
                userList.invalid && userList.touched ? true : null
              "
              (selectedChange)="updateUserCoordinations()"
            >
              <nb-option *ngFor="let user of USERS" [value]="user._id">
                {{ user.fullName }}
              </nb-option>
            </nb-select>
          </div>
        </div>
        <div class="col-md-5">
          <div class="form-control-group">
            <label class="label" for="input-memberCoordination"
              >Coordenação:</label
            >
            <nb-select
              [(ngModel)]="teamMember.coordination"
              #memberCoordination="ngModel"
              id="input-memberCoordination"
              name="memberCoordination"
              placeholder="Coordenação"
              fullWidth
              size="large"
              [status]="memberCoordination.value ? 'success' : 'basic'"
              [attr.aria-invalid]="
                memberCoordination.invalid && memberCoordination.touched
                  ? true
                  : null
              "
            >
              <nb-option
                *ngFor="let coordination of USER_COORDINATIONS"
                [value]="coordination"
              >
                {{ coordination }}
              </nb-option>
            </nb-select>
          </div>
        </div>
        <div class="col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="!memberCoordination.value || !userList.value"
            (click)="addColaborator(); memberCoordination.reset()"
          >
            +
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item *ngFor="let member of invoice.team; let i = index">
          <div class="row irow">
            <div class="col-12 col-md-6">
              {{
                member.user.fullName
                  ? member.user.fullName
                  : idToName(member.user)
              }}
            </div>
            <div class="col-10 col-md-5">
              {{ member.coordination }}
            </div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="invoice.team.splice(i, 1)"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
      </nb-list>
      <div class="form-control-group">
        <label
          class="label"
          for="input-subject"
          style="width: 100%; display: flex"
          >Assunto:
          <span style="text-align: right; width: 100%"
            >(Negrito: *!texto*)</span
          ></label
        >
        <textarea
          nbInput
          [(ngModel)]="invoice.subject"
          #subject="ngModel"
          id="input-subject"
          name="subject"
          placeholder="Digite o assunto da proposta de orçamento. Para texto em negrito use os delimitadores *! *. ex: *!texto*"
          fullWidth
          fieldSize="large"
          [minlength]="validation.subject.minLength"
          [maxlength]="validation.subject.maxLength"
          [status]="
            subject.dirty ? (subject.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="subject.invalid && subject.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="subject.invalid && subject.touched">
          <p
            class="caption status-danger"
            *ngIf="subject.errors?.minlength || subject.errors?.maxlength"
          >
            O assunto deve conter entre
            {{ validation.subject.minLength }} a
            {{ validation.subject.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="col-auto">
          <label class="label-divider">Etapa Preliminar</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-peep">Período de execução: </label>
        <textarea
          nbInput
          [(ngModel)]="invoice.peep"
          #peep="ngModel"
          id="input-peep"
          name="peep"
          placeholder="Digite o texto do período de execução"
          fullWidth
          fieldSize="large"
          [minlength]="validation.peep.minLength"
          [maxlength]="validation.peep.maxLength"
          [status]="
            peep.dirty ? (peep.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="peep.invalid && peep.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="peep.invalid && peep.touched">
          <p
            class="caption status-danger"
            *ngIf="peep.errors?.minlength || peep.errors?.maxlength"
          >
            O período de execução deve conter entre
            {{ validation.peep.minLength }} a
            {{ validation.peep.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row">
        <div class="col-md-11">
          <div class="form-control-group">
            <label class="label" for="input-aep">Atividades:</label>
            <input
              nbInput
              [(ngModel)]="options.aep"
              #laep="ngModel"
              id="input-aep"
              name="laep"
              placeholder="Atividade"
              fullWidth
              fieldSize="large"
              [status]="laep.value ? 'success' : 'basic'"
              [attr.aria-invalid]="laep.invalid && laep.touched ? true : null"
            />
          </div>
        </div>
        <div class="col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="!laep.value"
            (click)="invoice.laep.push(options.aep); options.aep = ''"
          >
            +
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item *ngFor="let activity of invoice.laep; let i = index">
          <div class="row irow">
            <div class="col-10 col-md-11">{{ activity }}</div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="invoice.laep.splice(i, 1)"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
      </nb-list>
      <div class="form-control-group">
        <label class="label" for="input-dep">Detalhes: </label>
        <textarea
          nbInput
          [(ngModel)]="invoice.dep"
          #dep="ngModel"
          id="input-dep"
          name="dep"
          placeholder="Digite o texto do período de execução"
          fullWidth
          fieldSize="large"
          [minlength]="validation.dep.minLength"
          [maxlength]="validation.dep.maxLength"
          [status]="dep.dirty ? (dep.invalid ? 'danger' : 'success') : 'basic'"
          [attr.aria-invalid]="dep.invalid && dep.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="dep.invalid && dep.touched">
          <p
            class="caption status-danger"
            *ngIf="dep.errors?.minlength || dep.errors?.maxlength"
          >
            O período de execução deve conter entre
            {{ validation.dep.minLength }} a
            {{ validation.dep.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="col-auto">
          <label class="label-divider">Etapa Executiva</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-peee">Período de execução: </label>
        <textarea
          nbInput
          [(ngModel)]="invoice.peee"
          #peee="ngModel"
          id="input-peee"
          name="peee"
          placeholder="Digite o texto do período de execução"
          fullWidth
          fieldSize="large"
          [minlength]="validation.peee.minLength"
          [maxlength]="validation.peee.maxLength"
          [status]="
            peee.dirty ? (peee.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="peee.invalid && peee.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="peee.invalid && peee.touched">
          <p
            class="caption status-danger"
            *ngIf="peee.errors?.minlength || peee.errors?.maxlength"
          >
            O período de execução deve conter entre
            {{ validation.peee.minLength }} a
            {{ validation.peee.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row">
        <div class="col-md-11">
          <div class="form-control-group">
            <label class="label" for="input-aee">Atividades:</label>
            <input
              nbInput
              [(ngModel)]="options.aee"
              #laee="ngModel"
              id="input-aee"
              name="laee"
              placeholder="Atividade"
              fullWidth
              fieldSize="large"
              [status]="laee.value ? 'success' : 'basic'"
              [attr.aria-invalid]="laee.invalid && laee.touched ? true : null"
            />
          </div>
        </div>
        <div class="col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="!laee.value"
            (click)="invoice.laee.push(options.aee); options.aee = ''"
          >
            +
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item *ngFor="let activity of invoice.laee; let i = index">
          <div class="row irow">
            <div class="col-10 col-md-11">{{ activity }}</div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="invoice.laee.splice(i, 1)"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
      </nb-list>
      <div class="form-control-group">
        <label class="label" for="input-dee">Detalhes: </label>
        <textarea
          nbInput
          [(ngModel)]="invoice.dee"
          #dee="ngModel"
          id="input-dee"
          name="dee"
          placeholder="Digite o texto do período de execução"
          fullWidth
          fieldSize="large"
          [minlength]="validation.dee.minLength"
          [maxlength]="validation.dee.maxLength"
          [status]="dee.dirty ? (dee.invalid ? 'danger' : 'success') : 'basic'"
          [attr.aria-invalid]="dee.invalid && dee.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="dee.invalid && dee.touched">
          <p
            class="caption status-danger"
            *ngIf="dee.errors?.minlength || dee.errors?.maxlength"
          >
            O período de execução deve conter entre
            {{ validation.dee.minLength }} a
            {{ validation.dee.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="col-auto">
          <label class="label-divider">Etapa Complementar</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-peec">Período de execução: </label>
        <textarea
          nbInput
          [(ngModel)]="invoice.peec"
          #peec="ngModel"
          id="input-peec"
          name="peec"
          placeholder="Digite o texto do período de execução"
          fullWidth
          fieldSize="large"
          [minlength]="validation.peec.minLength"
          [maxlength]="validation.peec.maxLength"
          [status]="
            peec.dirty ? (peec.invalid ? 'danger' : 'success') : 'basic'
          "
          [attr.aria-invalid]="peec.invalid && peec.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="peec.invalid && peec.touched">
          <p
            class="caption status-danger"
            *ngIf="peec.errors?.minlength || peec.errors?.maxlength"
          >
            O período de execução deve conter entre
            {{ validation.peec.minLength }} a
            {{ validation.peec.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row">
        <div class="col-md-11">
          <div class="form-control-group">
            <label class="label" for="input-aec">Atividades:</label>
            <input
              nbInput
              [(ngModel)]="options.aec"
              #laec="ngModel"
              id="input-aec"
              name="laec"
              placeholder="Atividade"
              fullWidth
              fieldSize="large"
              [status]="laec.value ? 'success' : 'basic'"
              [attr.aria-invalid]="laec.invalid && laec.touched ? true : null"
            />
          </div>
        </div>
        <div class="col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="!laec.value"
            (click)="invoice.laec.push(options.aec); options.aec = ''"
          >
            +
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item *ngFor="let activity of invoice.laec; let i = index">
          <div class="row irow">
            <div class="col-10 col-md-11">{{ activity }}</div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="invoice.laec.splice(i, 1)"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
      </nb-list>
      <div class="form-control-group">
        <label class="label" for="input-dec">Detalhes: </label>
        <textarea
          nbInput
          [(ngModel)]="invoice.dec"
          #dec="ngModel"
          id="input-dec"
          name="dec"
          placeholder="Digite o texto do período de execução"
          fullWidth
          fieldSize="large"
          [minlength]="validation.dec.minLength"
          [maxlength]="validation.dec.maxLength"
          [status]="dec.dirty ? (dec.invalid ? 'danger' : 'success') : 'basic'"
          [attr.aria-invalid]="dec.invalid && dec.touched ? true : null"
          [disabled]="false"
        ></textarea>
        <ng-container *ngIf="dec.invalid && dec.touched">
          <p
            class="caption status-danger"
            *ngIf="dec.errors?.minlength || dec.errors?.maxlength"
          >
            O período de execução deve conter entre
            {{ validation.dec.minLength }} a
            {{ validation.dec.maxLength }}
            caracteres
          </p>
        </ng-container>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="col-auto">
          <label class="label-divider">Valores</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="row">
        <div class="col-md-8">
          <div class="form-control-group">
            <label class="label" for="input-product">Produto:</label>
            <input
              nbInput
              [(ngModel)]="options.product.name"
              #product="ngModel"
              id="input-product"
              name="product"
              placeholder="Nome do produto"
              fullWidth
              fieldSize="large"
              [status]="product.value ? 'success' : 'basic'"
              [attr.aria-invalid]="
                product.invalid && product.touched ? true : null
              "
            />
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-control-group">
            <label
              class="label"
              for="input-paid"
              style="display: flex; margin-top: 4px"
            >
              <span style="margin-right: 10px">Valor:</span>
              <nb-radio-group
                [(ngModel)]="options.valueType"
                #valueType="ngModel"
                id="input-value-type"
                name="valueType"
                style="height: 16px"
              >
                <nb-radio value="$" style="height: 16px">R$</nb-radio>
                <nb-radio value="%" style="height: 16px">%</nb-radio>
              </nb-radio-group>
            </label>
            <input
              nbInput
              [(ngModel)]="options.product.value"
              #paid="ngModel"
              id="input-paid"
              name="paid"
              placeholder="Valor"
              fullWidth
              fieldSize="large"
              [brmasker]="{
                money: true,
                thousand: '.',
                decimalCaracter: ',',
                decimal: '2'
              }"
              [status]="paid.value ? 'success' : 'basic'"
              [attr.aria-invalid]="paid.invalid && paid.touched ? true : null"
            />
          </div>
        </div>
        <div class="col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="!product.value || !paid.value"
            (click)="addProduct()"
          >
            +
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item *ngFor="let product of invoice.products; let i = index">
          <div class="row paymentRow">
            <div class="col-12 col-md-7">
              {{ product.name }}
              <nb-list
                class="subproducts-list"
                *ngIf="product.subproducts.length > 0"
              >
                <nb-list-item
                  *ngFor="let subproduct of product.subproducts; let j = index"
                >
                  <div class="row paymentRow">
                    <div class="col-10 col-md-11">{{ subproduct }}</div>
                    <div class="col-2 col-md-1" style="text-align: right">
                      <nb-icon
                        class="xIcon"
                        status="basic"
                        icon="trash-2-outline"
                        pack="eva"
                        (click)="product.subproducts.splice(j, 1)"
                      ></nb-icon>
                    </div>
                  </div>
                </nb-list-item>
              </nb-list>
            </div>
            <div class="col-5 col-md-2">
              {{ product.value }}
            </div>
            <div class="col-4 col-md-1">
              {{ stringUtil.toPercentage(product.value, invoice.value) }}
            </div>
            <div class="col-3 col-md-2" style="text-align: right">
              <nb-icon
                class="addIcon"
                status="basic"
                icon="plus-outline"
                pack="eva"
                (click)="addSubproduct(product)"
              ></nb-icon>
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="invoice.products.splice(i, 1); updateTotal('product')"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
        <nb-list-item>
          <div class="row paymentRow">
            <div class="col-12 col-md-4">
              Restante: {{ remainingBalance('product') }}
            </div>
            <div class="col-4 col-md-3" style="text-align: right">Total:</div>
            <div
              class="col-4 col-md-2"
              [ngClass]="{
                danger:
                  options.total !== invoice.value && options.total !== '0',
                success:
                  options.total === invoice.value && options.total !== '0'
              }"
            >
              {{ options.total }}
            </div>
            <div
              class="col-4 col-md-1"
              [ngClass]="{
                danger:
                  options.total !== invoice.value && options.total !== '0',
                success:
                  options.total === invoice.value && options.total !== '0'
              }"
            >
              {{ stringUtil.toPercentage(options.total, invoice.value) }}
            </div>
            <div class="col-md-2"></div>
          </div>
        </nb-list-item>
      </nb-list>
      <div class="row">
        <div class="col-md-8">
          <div class="form-control-group">
            <label class="label" for="input-stage">Etapas:</label>
            <input
              nbInput
              [(ngModel)]="options.stage.name"
              #stage="ngModel"
              id="input-stage"
              name="stage"
              placeholder="Nome da etapa"
              fullWidth
              fieldSize="large"
              [status]="stage.value ? 'success' : 'basic'"
              [attr.aria-invalid]="stage.invalid && stage.touched ? true : null"
            />
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-control-group">
            <label
              class="label"
              for="input-paid"
              style="display: flex; margin-top: 4px"
            >
              <span style="margin-right: 10px">Valor:</span>
              <nb-radio-group
                [(ngModel)]="options.stageValueType"
                #stageValueType="ngModel"
                id="input-value-type"
                name="stageValueType"
                style="height: 16px"
              >
                <nb-radio value="$" style="height: 16px">R$</nb-radio>
                <nb-radio value="%" style="height: 16px">%</nb-radio>
              </nb-radio-group>
            </label>
            <input
              nbInput
              [(ngModel)]="options.stage.value"
              #stagePaid="ngModel"
              id="input-stagePaid"
              name="stagePaid"
              placeholder="Valor"
              fullWidth
              fieldSize="large"
              [brmasker]="{
                money: true,
                thousand: '.',
                decimalCaracter: ',',
                decimal: '2'
              }"
              [status]="stagePaid.value ? 'success' : 'basic'"
              [attr.aria-invalid]="
                stagePaid.invalid && stagePaid.touched ? true : null
              "
            />
          </div>
        </div>
        <div class="col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="!stage.value || !stagePaid.value"
            (click)="addStage()"
          >
            +
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item *ngFor="let stage of invoice.stages; let i = index">
          <div class="row paymentRow">
            <div class="col-12 col-md-8">
              {{ stage.name }}
            </div>
            <div class="col-5 col-md-2">
              {{ stage.value }}
            </div>
            <div class="col-5 col-md-1">
              {{ stringUtil.toPercentage(stage.value, invoice.value) }}
            </div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="invoice.stages.splice(i, 1); updateTotal('stage')"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
        <nb-list-item>
          <div class="row paymentRow">
            <div class="col-12 col-md-4">
              Restante: {{ remainingBalance('stage') }}
            </div>
            <div class="col-4 col-md-4" style="text-align: right">Total:</div>
            <div
              class="col-4 col-md-2"
              [ngClass]="{
                danger:
                  options.stageTotal !== invoice.value &&
                  options.stageTotal !== '0',
                success:
                  options.stageTotal === invoice.value &&
                  options.stageTotal !== '0'
              }"
            >
              {{ options.stageTotal }}
            </div>
            <div
              class="col-4 col-md-1"
              [ngClass]="{
                danger:
                  options.stageTotal !== invoice.value &&
                  options.stageTotal !== '0',
                success:
                  options.stageTotal === invoice.value &&
                  options.stageTotal !== '0'
              }"
            >
              {{ stringUtil.toPercentage(options.stageTotal, invoice.value) }}
            </div>
            <div class="col-md-1"></div>
          </div>
        </nb-list-item>
      </nb-list>
      <div class="row">
        <div class="col-md-11">
          <div class="form-control-group">
            <label class="label" for="input-important">Importante:</label>
            <input
              nbInput
              [(ngModel)]="options.important"
              #important="ngModel"
              id="input-important"
              name="limportant"
              placeholder="Atividade"
              fullWidth
              fieldSize="large"
              [status]="important.value ? 'success' : 'basic'"
              [attr.aria-invalid]="
                important.invalid && important.touched ? true : null
              "
            />
          </div>
        </div>
        <div class="col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="!important.value"
            (click)="
              invoice.importants.push(options.important); options.important = ''
            "
          >
            +
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item
          *ngFor="let activity of invoice.importants; let i = index"
        >
          <div class="row irow">
            <div class="col-10 col-md-11">{{ activity }}</div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="invoice.importants.splice(i, 1)"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
      </nb-list>
    </nb-tab>
  </nb-tabset>

  <button
    nbButton
    fullWidth
    status="primary"
    size="large"
    style="margin-top: 20px"
    [disabled]="submitted || !form.valid"
    [class.btn-pulse]="submitted"
  >
    {{ editing ? 'Atualizar' : 'Cadastrar' }}
  </button>
</form>
